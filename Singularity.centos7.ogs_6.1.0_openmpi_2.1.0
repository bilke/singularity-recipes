# GCC 5.3.1
Bootstrap: docker
From: centos/devtoolset-4-toolchain-centos7

%environment
    CC=/opt/rh/devtoolset-4/root/bin/gcc
    CXX=/opt/rh/devtoolset-4/root/bin/g++
    LD_LIBRARY_PATH=/opt/rh/devtoolset-4/root/usr/lib/gcc/x86_64-redhat-linux/5.3.1:$LD_LIBRARY_PATH
    unset HOME
    export CC CXX LD_LIBRARY_PATH

%post
  yum -y install epel-release
  yum -y install make perl
  curl -L https://www.open-mpi.org/software/ompi/v2.1/downloads/openmpi-2.1.0.tar.gz -O 
  tar xf openmpi-2.1.0.tar.gz
  cd openmpi-2.1.0
  CC=/opt/rh/devtoolset-4/root/bin/gcc CXX=/opt/rh/devtoolset-4/root/bin/g++ ./configure --prefix=/usr/local
  make -j $(nproc)
  make install
  mpicc examples/ring_c.c -o ring
  cp ./ring /usr/bin/

##############################
# dev
##############################

%appenv dev
  CC=mpicc
  CXX=mpic++
  export CC CXX

%appinstall dev
  yum -y install git
  curl -s https://packagecloud.io/install/repositories/github/git-lfs/script.rpm.sh | bash
  yum -y install git-lfs

  yum -y install python-pip unzip

  python -m pip install --upgrade pip
  python -m pip install cmake conan

  curl -L -o ninja-linux.zip https://github.com/ninja-build/ninja/releases/download/v1.8.2/ninja-linux.zip
  unzip ninja-linux.zip
  mv ninja /usr/local/bin/ninja
  rm ninja-linux.zip

  yum -y install mesa-libGL-devel libXt-devel # maybe not required when Conan VTK x11=False

  # build ogs here
  git lfs clone --branch singularity --depth=1 https://github.com/bilke/ogs || echo "Source already cloned"
  rm -rf build && mkdir build && cd build
  CC=mpicc CXX=mpic++ cmake ../ogs -G Ninja -DCMAKE_BUILD_TYPE=Release -DOGS_USE_CONAN=ON -DCMAKE_INSTALL_PREFIX=$SINGULARITY_APPROOT -DOGS_USE_PETSC=ON
  ninja install

%apprun dev
  exec $SINGULARITY_APPROOT/bin/ogs "$@"
